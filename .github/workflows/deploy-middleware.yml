name: Deploy GHIN Middleware to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      run_health_check:
        description: 'Run post-deploy health check (may be blocked by IP restrictions)'
        required: false
        default: false
        type: boolean

env:
  AZURE_WEBAPP_NAME: golfmatch-ghin-middleware
  NODE_VERSION: '20.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test --if-present

    - name: Create deployment package
      shell: bash
      run: |
        set -euo pipefail
        echo "Creating deploy.zip (Azure will run npm install)"
        rm -f deploy.zip
        zip -r deploy.zip \
          src \
          package.json \
          package-lock.json \
          README.md \
          GETTING-STARTED.md \
          -x "wwwroot/**" "logs/**" "logs_temp/**" "logs_temp2/**" "coverage/**" "dist/**" "build/**" "node_modules/**"

    - name: Parse publish profile
      id: ppmeta
      shell: bash
      env:
        PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
      run: |
        set -euo pipefail
        # Write secret to file (masked in logs)
        echo "$PUBLISH_PROFILE" > publish_profile.xml
        python3 - <<'PY'
        import sys, xml.etree.ElementTree as ET
        with open('publish_profile.xml','r') as f:
            xml=f.read()
        try:
            root=ET.fromstring(xml)
        except Exception as e:
            print('ERROR: Publish profile XML parse failed:', e)
            sys.exit(1)
        profiles=root.findall('publishProfile')
        if not profiles:
          print('ERROR: No publishProfile entries found in secret.')
          sys.exit(1)
        ms = next((p for p in profiles if p.get('publishMethod')=='MSDeploy'), None)
        if ms is None:
            print('ERROR: MSDeploy profile not found in secret.')
            sys.exit(1)
        # Validate MSDeploy credentials only; other profiles (e.g., FTP) may be redacted
        ms_user = (ms.get('userName') or '').strip()
        ms_pwd = (ms.get('userPWD') or '').strip()
        if not ms_user or not ms_pwd or ms_user.upper()=='REDACTED' or ms_pwd.upper()=='REDACTED':
          print('ERROR: MSDeploy credentials are missing or REDACTED. Re-download publish profile from Azure Portal and paste full XML into secret.')
          sys.exit(1)
        appname = ms.get('msdeploySite') or ''
        if not appname:
            print('ERROR: msdeploySite missing from publish profile.')
            sys.exit(1)
        print('Publish profile OK. App name from msdeploySite:', appname)
        with open('/tmp/gout','w') as gout:
            gout.write(f"app_name={appname}\n")
        PY
        cat /tmp/gout >> "$GITHUB_OUTPUT"
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      id: deploywebapp
      with:
        app-name: ${{ steps.ppmeta.outputs.app_name }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: deploy.zip
      continue-on-error: false

    - name: Test deployment (retry until healthy)
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_health_check == true }}
      shell: bash
      run: |
        set -euo pipefail
        APP_URL="https://${{ steps.ppmeta.outputs.app_name }}.azurewebsites.net/api/v1/health"
        echo "Checking health at $APP_URL"
        attempts=30
        delay=10
        for i in $(seq 1 $attempts); do
          if curl -fsSL "$APP_URL" | tee health.json | grep -q '"status":"healthy"'; then
            echo "Health check passed on attempt $i"
            exit 0
          fi
          echo "Attempt $i failed; waiting $delay seconds..."
          sleep $delay
        done
        echo "Health check did not pass after $attempts attempts"
        echo "Last response:" && cat health.json || true
        exit 1

  cleanup-artifacts:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Prune old artifacts (keep 2 newest)
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          KEEP: 2
        run: |
          artifacts=$(gh api repos/$REPO/actions/artifacts --paginate \
            --jq '.artifacts | sort_by(.created_at) | reverse')
          echo "$artifacts" | jq -c ".[$KEEP:]" | jq -r '.[].id' | while read -r id; do
            [ -n "$id" ] || continue
            echo "Deleting artifact $id"
            gh api -X DELETE repos/$REPO/actions/artifacts/$id > /dev/null
          done
