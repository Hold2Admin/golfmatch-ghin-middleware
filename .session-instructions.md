# GolfMatch GHIN Middleware — Session Instructions

## Git & GitHub Workflow

**CRITICAL RULE: Never automatically push to GitHub.**

1. Make file edits and commit changes **locally only**
2. Inform the user when changes are ready and staged
3. Wait for explicit approval before pushing to remote
4. This prevents workflow disruptions and CI/CD complications

**Example:**
```
✅ Files committed locally:
   - src/routes/courses.js (updated)
   - MIDDLEWARE-ARCHITECTURE.md (new)
   
Ready to push when you approve.
```

## Project Context

- **Repository:** https://github.com/Hold2Admin/golfmatch-ghin-middleware
- **Type:** Node.js 20.x Express API (GHIN middleware for Fore Play)
- **Purpose:** Cache course/tee/hole data; serve player search; future direct GHIN API integration
- **Database:** Azure SQL `golfdb` on `golfmatchserver.database.windows.net`
- **Deployment:** Azure App Service (App Service `golfmatch-ghin-middleware`)
- **Architecture Guide:** [MIDDLEWARE-ARCHITECTURE.md](MIDDLEWARE-ARCHITECTURE.md)

## Key Components

### Endpoints
- **Players:** `POST /api/v1/players/search` — GHIN member lookup (gender-based tee selection)
- **Courses:** `GET /api/v1/courses/state/:state`, `/courses/:courseId/tees`, `/courses/:courseId/holes` — Course/tee/hole baseline serving
- **Health:** `GET /api/v1/health` — Status check

### Mock Data
- **File:** [src/mocks/ghinData.js](src/mocks/ghinData.js)
- **Players:** Clayton Cobb (GHIN 1234567, M, HI 9.4), Michael Draskin (2345678, M, +1.0), Ryan Kayton (3456789, M, 2.3)
- **Courses:** Cedar Ridge GC (GHIN-54321, Boulder CO) with 4 tees (Blue M/W defaults, White M/W), all with full 18-hole baselines

### Database Schema
- **Export Location:** [db-schema/golfmatch/](db-schema/golfmatch/)
- **Key Tables:** Courses, Tees, CourseDefaults, HoleDefaults, HoleOverrides, TeeRatings
- **Key Procedures:** usp_GetEffectiveHoleData, usp_CreateCourseWithDefaults, usp_AddTeeForCourseWithRatings, etc.

## Common Workflows

### Test Locally
```bash
npm run dev                  # Starts on :3000 with mocks
./scripts/gm.ps1           # PowerShell helper
Set-GmKey                  # Fetch API key from Key Vault
gmx-local /api/v1/players/search -Method POST -Body '{"ghinNumber":"1234567"}'
gmx-local /api/v1/courses/state/CO
gmx-local /api/v1/courses/GHIN-54321/tees
gmx-local "/api/v1/courses/GHIN-54321/holes?teeId=GHIN-TEE-1001&gender=M"
```

### Export Schema
```bash
node scripts/export-schema.js  # Dumps golfdb schema (read-only via Key Vault creds)
```

### Add a File Change
1. Make edits
2. Commit locally: `git add <files> && git commit -m "..."`
3. Wait for user approval before pushing

## Important Notes

- **No .env.local in production:** All secrets from Azure Key Vault only
- **API Key Auth:** All requests require `X-API-Key` header
- **Gender-Based Tee Selection:** Critical for player workflow — use gender from player search to filter tees
- **Course Handicap:** Calculated as player HI + (tee slope rating / 113)
- **Future Phases:** Phase 2 = nightly GHIN sync; Phase 3 = player handicap caching + refresh endpoint

## Integration Point

Fore Play (golfmatch-api) calls middleware endpoints:
1. `POST /api/v1/players/search` → Get player gender + handicap
2. `GET /api/v1/courses/state/:state` → List courses
3. `GET /api/v1/courses/:courseId/tees` → Fetch tees (filtered by gender)
4. `GET /api/v1/courses/:courseId/holes?teeId=:teeId&gender=:gender` → Fetch hole baselines
5. Upsert into golfmatch-api's canonical `Courses`, `Tees`, `CourseDefaults`, `HoleDefaults` tables

See [MIDDLEWARE-ARCHITECTURE.md](MIDDLEWARE-ARCHITECTURE.md) for full integration details.
